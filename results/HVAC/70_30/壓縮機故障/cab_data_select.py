import pandas as pd
import os # 匯入 os 模組來處理檔案路徑

# (已移除所有內部切割邏輯)

# --- 1. CSV 檔案名稱 ---
# (已更新為您提供的路徑)
csv_file_name = 'D:\DACAD-_no_target\駕駛室資料\cab_data.csv'

# --- 2. 時間欄位名稱 ---
time_column_name = 'datetime'

# --- 3. 定義資料集 ---
    # ('2025-04-11 09:14:01', '2025-04-11 09:44:00',0),#冷凝盤管阻塞20%
    # ('2025-04-11 09:46:01', '2025-04-11 10:16:00',0),#冷凝盤管阻塞30%
    # ('2025-04-11 10:29:01', '2025-04-11 10:59:00',0),#蒸發盤管阻塞10%
    # ('2025-04-11 11:01:01', '2025-04-11 11:31:00',0),#蒸發盤管阻塞20%
    # ('2025-04-11 11:33:01', '2025-04-11 12:03:00',0),#蒸發盤管阻塞23%
    # ('2025-04-11 12:05:01', '2025-04-11 13:35:00',0),#正常資料常溫34度
    # ('2025-04-11 13:45:01', '2025-04-11 14:15:00',0),#蒸發風扇電流90%
    # ('2025-04-11 14:19:01', '2025-04-11 14:49:00',0),#蒸發風扇電流80%
    # ('2025-04-11 14:52:01', '2025-04-11 15:22:00',0),#蒸發風扇電流70%
    # ('2025-04-11 15:46:01', '2025-04-11 16:16:00',0),#正常資料高溫42.7度
    # ('2025-04-14 09:00:01', '2025-04-14 10:00:00',0),#正常資料低溫24度
    # ('2025-04-14 10:49:01', '2025-04-14 11:45:00',0),#加熱器運轉
    # ('2025-04-14 13:25:01', '2025-04-14 14:25:00',0),#冷媒洩漏10%
    # ('2025-04-14 14:50:01', '2025-04-14 15:50:00',0),#冷媒洩漏20%
    # ('2026-01-01 00:00:01', '2026-01-01 01:30:00',0),#壓縮機故障10%
    # ('2026-01-01 01:30:01', '2026-01-01 03:00:00',0),#壓縮機故障20%
    # ('2026-01-01 03:00:01', '2026-01-01 04:30:00',0),#壓縮機故障30%
    # ('2026-01-01 05:00:01', '2026-01-01 06:30:00',0),#冷凝風扇電流上升10%
    # ('2026-01-01 06:30:01', '2026-01-01 08:00:00',0),#冷凝風扇電流上升20%
    # ('2026-01-01 08:00:01', '2026-01-01 09:30:00',0),#冷凝風扇電流上升30%
    # ('2026-01-01 10:00:01', '2026-01-01 11:30:00',0),#蒸發風扇電流上升10%
    # ('2026-01-01 11:30:01', '2026-01-01 13:00:00',0),#蒸發風扇電流上升20%
    # ('2026-01-01 13:00:01', '2026-01-01 14:30:00',0),#蒸發風扇電流上升30%
    # ('2026-01-01 15:00:01', '2026-01-01 15:56:00',0),#加熱器故障10%
    # ('2026-01-01 15:56:01', '2026-01-01 16:52:00',0),#加熱器故障20%
    # ('2026-01-01 16:52:01', '2026-01-01 17:48:00',0),#加熱器故障30%
    # ('2025-12-23 10:23:01', '2025-12-23 11:23:00',0),#正常資料低溫27度
    # ('2025-12-23 12:15:01', '2025-12-23 13:15:00',0),#正常資料常溫30度
    # ('2025-12-23 13:19:01', '2025-12-23 13:57:00',0),#輕度(兩層洗衣袋)冷凝盤管阻塞
    # ('2025-12-23 14:02:01', '2025-12-23 14:33:00',0),#重度(四層洗衣袋)冷凝盤管阻塞
    # ('2025-12-23 15:00:01', '2025-12-23 16:00:00',0),#冷媒洩漏30%




source_time_periods = [
    ('2025-04-11 09:14:01', '2025-04-11 09:44:00',0),#冷凝盤管阻塞20%
    ('2025-04-11 10:29:01', '2025-04-11 10:59:00',0),#蒸發盤管阻塞10%
    ('2025-04-11 11:33:01', '2025-04-11 12:03:00',0),#蒸發盤管阻塞23%
    ('2025-04-11 12:05:01', '2025-04-11 13:35:00',0),#正常資料常溫34度
    ('2025-04-11 13:45:01', '2025-04-11 14:15:00',0),#蒸發風扇電流90%
    ('2025-04-11 14:52:01', '2025-04-11 15:22:00',0),#蒸發風扇電流70%
    ('2025-04-11 15:46:01', '2025-04-11 16:16:00',0),#正常資料高溫42.7度
    ('2025-04-14 09:00:01', '2025-04-14 10:00:00',0),#正常資料低溫24度
    ('2025-04-14 13:25:01', '2025-04-14 14:25:00',0),#冷媒洩漏10%
    ('2025-04-14 14:50:01', '2025-04-14 15:50:00',0),#冷媒洩漏20%
    ('2026-01-01 00:00:01', '2026-01-01 01:30:00',1),#壓縮機故障10%
    ('2026-01-01 03:00:01', '2026-01-01 04:30:00',1),#壓縮機故障30%
    ('2026-01-01 05:00:01', '2026-01-01 06:30:00',0),#冷凝風扇電流上升10%
    ('2026-01-01 08:00:01', '2026-01-01 09:30:00',0),#冷凝風扇電流上升30%
    ('2026-01-01 10:00:01', '2026-01-01 11:30:00',0),#蒸發風扇電流上升10%
    ('2026-01-01 13:00:01', '2026-01-01 14:30:00',0),#蒸發風扇電流上升30%
    ('2025-12-23 10:23:01', '2025-12-23 11:23:00',0),#正常資料低溫27度
    ('2025-12-23 12:15:01', '2025-12-23 13:15:00',0),#正常資料常溫30度
    ('2025-12-23 13:27:01', '2025-12-23 13:57:00',0),#輕度(兩層洗衣袋)冷凝盤管阻塞
]


test_time_periods = [
    ('2025-04-11 09:46:01', '2025-04-11 10:16:00',0),#冷凝盤管阻塞30%
    ('2025-04-11 11:01:01', '2025-04-11 11:31:00',0),#蒸發盤管阻塞20%
    ('2025-04-11 14:19:01', '2025-04-11 14:49:00',0),#蒸發風扇電流80%
    ('2025-04-11 15:46:01', '2025-04-11 16:16:00',0),#正常資料高溫42.7度
    ('2025-04-14 09:00:01', '2025-04-14 10:00:00',0),#正常資料低溫24度
    ('2025-12-23 10:23:01', '2025-12-23 11:23:00',0),#正常資料低溫27度
    ('2025-12-23 12:15:01', '2025-12-23 13:15:00',0),#正常資料常溫30度
    ('2025-12-23 14:03:01', '2025-12-23 14:33:00',0),#重度(四層洗衣袋)冷凝盤管阻塞
    ('2025-12-23 15:00:01', '2025-12-23 16:00:00',0),#冷媒洩漏30%
    ('2026-01-01 01:30:01', '2026-01-01 03:00:00',1),#壓縮機故障20%
    ('2026-01-01 06:30:01', '2026-01-01 08:00:00',0),#冷凝風扇電流上升20%
    ('2026-01-01 11:30:01', '2026-01-01 13:00:00',0),#蒸發風扇電流上升20%
]

# --- 5. 請修改這裡：設定輸出的資料夾路徑 ---
# (已更新為您提供的路徑)
output_directory = 'D:\DACAD-_no_target\datasets\HVAC' # <-- 請在這裡填寫您想儲存的完整路徑

# --- 6. (RANDOM_SEED 已移除) ---


# --- 主程式開始 (以下部分通常不需要修改) ---

# 讀取 CSV 檔案
try:
    df = pd.read_csv(csv_file_name)
except FileNotFoundError:
    print(f"錯誤：找不到名為 '{csv_file_name}' 的檔案。")
    print(f"路徑 '{csv_file_name}' 不正確，或檔案不存在。")
    exit()
except Exception as e:
    print(f"讀取 CSV 檔案時發生錯誤: {e}")
    exit()

# 檢查時間欄位是否存在
if time_column_name not in df.columns:
    print(f"錯誤：在您的 CSV 檔案中找不到名為 '{time_column_name}' 的欄位。")
    print(f"檔案中包含的欄位有：{list(df.columns)}")
    exit()

# 將時間欄位轉換為 pandas 的 datetime 格式
df[time_column_name] = pd.to_datetime(df[time_column_name], errors='coerce')
df.dropna(subset=[time_column_name], inplace=True)
# 確保原始資料是按時間排序的
df.sort_values(by=time_column_name, inplace=True)


# --- 執行分割與處理 ---

# 0. 檢查並建立輸出資料夾
if output_directory and not os.path.exists(output_directory):
    os.makedirs(output_directory)
    print(f"\n已建立新資料夾：{output_directory}")


# --- 建立一個輔助函式來處理資料篩選、標記與儲存 ---
def process_and_save_periods(dataframe, periods_list, filename, output_dir):
    """
    根據給定的時間段列表，從 dataframe 中篩選、標記並合併資料，
    然後儲存成一個檔案。
    """
    if not periods_list:
        print(f"\n列表 {filename} 為空，跳過儲存。")
        return

    labeled_dfs = []
    
    # 迭代您設定的每一個時間段
    for start_str, end_str, label in periods_list:
        start_time = pd.to_datetime(start_str)
        end_time = pd.to_datetime(end_str)
        
        # 篩選「整個」時間段的資料
        mask = (dataframe[time_column_name] >= start_time) & (dataframe[time_column_name] <= end_time)
        period_df = dataframe[mask].copy()
        
        if not period_df.empty:
            period_df['label'] = label
            labeled_dfs.append(period_df)
        
    if not labeled_dfs:
        print(f"\n在 {filename} 的時間段中沒有找到任何資料。")
        return

    # 合併所有片段並儲存
    final_df = pd.concat(labeled_dfs).sort_values(by=time_column_name)
    output_path = os.path.join(output_dir, filename)
    final_df.to_csv(output_path, index=False, encoding='utf-8-sig')
    print(f"\n檔案已成功儲存至 {output_path} (共 {len(final_df)} 筆資料)")


# --- 1. 彙整並儲存 3 個檔案 ---
print("\n步驟 1: 正在處理並儲存 Source Data...")
process_and_save_periods(df, source_time_periods, 'source_data_train.csv', output_directory)

print("\n步驟 3: 正在處理並儲存 Test Data...")
process_and_save_periods(df, test_time_periods, 'test_data.csv', output_directory)

print("\n--- 所有資料處理與分割已完成 ---")
